<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Chronos | Material Design</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    :root {
      /* --- Material Design 3 Dark Token Palette --- */
      --md-sys-color-background: #111318;
      --md-sys-color-on-background: #E2E2E6;
      
      --md-sys-color-surface: #111318;
      --md-sys-color-surface-container-low: #191C20;
      --md-sys-color-surface-container: #1D2024;
      --md-sys-color-surface-container-high: #282A2F;
      
      --md-sys-color-primary: #A8C7FA; /* Google Blue Light */
      --md-sys-color-on-primary: #062E6F;
      --md-sys-color-primary-container: #0842A0;
      --md-sys-color-on-primary-container: #D6E3FF;

      --md-sys-color-secondary: #C4C7D0;
      --md-sys-color-tertiary: #E0C38C;
      
      --md-sys-color-error: #FFB4AB;
      --md-sys-color-outline: #8E9199;
      --md-sys-color-outline-variant: #44474F;

      /* Elevation/Shape */
      --shape-corner-small: 8px;
      --shape-corner-medium: 12px;
      --shape-corner-large: 16px;
      --shape-corner-xl: 28px;
      --shape-pill: 9999px;

      --ease-standard: cubic-bezier(0.2, 0.0, 0, 1.0);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    
    body {
      margin: 0; height: 100vh; overflow: hidden;
      background: var(--md-sys-color-background); 
      color: var(--md-sys-color-on-background);
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      line-height: 1.5;
    }

    /* Icon Helper */
    .material-symbols-rounded {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 24px; display: inline-block; vertical-align: middle;
    }
    .icon-fill { font-variation-settings: 'FILL' 1; }

    /* --- Layout --- */
    .app {
      position: relative; height: 100%; width: 100%;
      display: grid; grid-template-rows: 64px 1fr;
    }

    /* --- 1. Top App Bar --- */
    header {
      display: flex; justify-content: space-between; align-items: center; padding: 0 24px;
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-background);
      z-index: 10;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { font-size: 22px; font-weight: 400; margin: 0; color: var(--md-sys-color-on-background); }

    /* Logo - Simplified Geometry */
    .logo { width: 32px; height: 32px; }
    
    .top-actions { display: flex; gap: 8px; }

    /* Material Buttons */
    .btn-tonal {
      height: 40px; padding: 0 24px 0 16px; border-radius: var(--shape-pill);
      background: var(--md-sys-color-surface-container-high); 
      color: var(--md-sys-color-on-background); border: none;
      display: flex; align-items: center; gap: 8px;
      cursor: pointer; transition: background 0.2s;
      font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 500; letter-spacing: 0.1px;
    }
    .btn-tonal:hover { background: #33353A; }
    .btn-tonal span { font-size: 20px; }

    .btn-icon {
      width: 48px; height: 48px; border-radius: 50%;
      display: grid; place-items: center; background: transparent;
      color: var(--md-sys-color-on-background); cursor: pointer; transition: 0.2s;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.08); }
    .btn-icon.active { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }

    /* --- 2. Stage (Main View) --- */
    .stage { position: relative; display: flex; align-items: center; justify-content: center; height: 100%; overflow: hidden; }

    /* Chart Container */
    .chart-wrapper {
      width: 65vh; height: 65vh; max-width: 650px; max-height: 650px;
      position: relative; 
      /* Material Elevation 1 */
      /* filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)) drop-shadow(0 1px 3px rgba(0,0,0,0.15)); */
    }
    svg { overflow: visible; width: 100%; height: 100%; }

    .track { fill: none; stroke: var(--md-sys-color-surface-container); stroke-width: 40; }
    
    path.segment {
      cursor: pointer; transform-origin: 210px 210px;
      transition: transform 0.4s var(--ease-standard), filter 0.2s;
      stroke: var(--md-sys-color-background); stroke-width: 2px; /* Gap between segments */
    }
    path.segment:hover, path.segment.active {
      filter: brightness(1.1); transform: scale(1.04);
    }

    /* Clock Face */
    .ticks line { stroke: var(--md-sys-color-outline-variant); stroke-width: 1; }
    .ticks line.major { stroke: var(--md-sys-color-on-background); stroke-width: 2; }
    .tick-lbl { font-size: 12px; fill: var(--md-sys-color-secondary); text-anchor: middle; font-family: 'Roboto Mono'; pointer-events: none; }

    #nowMarker {
      fill: var(--md-sys-color-error);
      transform-origin: 210px 210px; pointer-events: none;
      transition: transform 1s linear;
    }

    /* Center Info (Floating) */
    .hub {
      position: absolute; inset: 50% auto auto 50%; transform: translate(-50%, -50%);
      width: 180px; height: 180px; border-radius: 50%;
      background: var(--md-sys-color-surface-container-low);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      pointer-events: none; text-align: center;
      box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15); /* Elevation 2 */
    }
    .hub-time { font-size: 42px; font-weight: 400; color: var(--md-sys-color-on-background); font-family: 'Roboto'; letter-spacing: -1px; }
    .hub-act { font-size: 14px; font-weight: 500; color: var(--md-sys-color-primary); margin-top: -4px; max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hub-rem { font-size: 12px; color: var(--md-sys-color-secondary); margin-top: 4px; }

    /* --- 3. Floating Controls & Legend --- */
    .layout-dock {
      position: absolute; bottom: 32px; right: 32px; top: 90px;
      display: flex; flex-direction: column; align-items: flex-end; gap: 16px;
      pointer-events: none; justify-content: flex-end;
    }

    .fab-group { pointer-events: auto; display: flex; flex-direction: column; gap: 12px; }

    /* Floating Action Button (FAB) style for Edit */
    .fab-large {
      width: 56px; height: 56px; border-radius: 16px;
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      display: grid; place-items: center; cursor: pointer;
      box-shadow: 0 4px 8px 3px rgba(0, 0, 0, 0.15);
      transition: 0.2s var(--ease-standard);
    }
    .fab-large:hover { filter: brightness(1.08); box-shadow: 0 6px 10px 4px rgba(0, 0, 0, 0.15); }
    .fab-small {
      width: 48px; height: 48px; border-radius: 12px;
      background: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-on-surface);
      display: grid; place-items: center; cursor: pointer;
      box-shadow: 0 2px 6px 2px rgba(0, 0, 0, 0.15);
      transition: 0.2s;
    }
    .fab-small.active { background: var(--md-sys-color-secondary); color: #000; }

    /* Legend Card */
    .legend-panel {
      pointer-events: auto; width: 300px; max-height: 50vh;
      background: var(--md-sys-color-surface-container);
      border-radius: var(--shape-corner-xl);
      display: flex; flex-direction: column; overflow: hidden;
      transition: 0.3s var(--ease-standard); transform-origin: bottom right;
      box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
    }
    .legend-panel.hidden { opacity: 0; transform: scale(0.9) translateY(20px); pointer-events: none; }

    .l-head { padding: 24px 24px 12px; font-size: 18px; color: var(--md-sys-color-on-background); font-weight: 500; }
    .l-list { flex: 1; overflow-y: auto; padding: 0 12px 24px; }
    .l-item { display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: var(--shape-pill); cursor: pointer; transition: 0.2s; }
    .l-item:hover { background: rgba(255,255,255,0.05); }
    .l-item.active { background: rgba(168, 199, 250, 0.12); }
    
    .l-dot { width: 12px; height: 12px; border-radius: 50%; }
    .l-info { flex: 1; }
    .l-name { font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-background); }
    .l-time { font-size: 12px; color: var(--md-sys-color-secondary); font-family: 'Roboto Mono'; margin-top: 2px; }
    .l-dur { font-weight: 500; font-size: 12px; color: var(--md-sys-color-on-background); }

    /* HUD (Bottom Left Toast) */
    .hud {
      position: absolute; bottom: 32px; left: 32px;
      background: var(--md-sys-color-surface-container-high);
      border-radius: 28px; padding: 16px 24px;
      transform: translateY(20px); opacity: 0; transition: 0.3s var(--ease-standard); pointer-events: none;
      box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15);
      display: flex; flex-direction: column; gap: 4px;
    }
    .hud.visible { transform: translateY(0); opacity: 1; }
    .hud-l { font-size: 11px; color: var(--md-sys-color-tertiary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
    .hud-n { font-size: 16px; font-weight: 500; color: var(--md-sys-color-on-background); }
    .hud-t { font-family: 'Roboto Mono'; color: var(--md-sys-color-secondary); font-size: 12px; }

    /* --- Menus --- */
    .dropdown-wrapper { position: relative; }
    .dropdown-menu {
      position: absolute; top: 100%; right: 0; margin-top: 8px; width: 260px;
      background: var(--md-sys-color-surface-container);
      border-radius: 4px; border-radius: var(--shape-corner-medium);
      padding: 8px 0; z-index: 100;
      box-shadow: 0 2px 6px 2px rgba(0,0,0,0.15);
      display: none; flex-direction: column;
      transform-origin: top right;
    }
    .dropdown-menu.show { display: flex; animation: fadeScale 0.15s var(--ease-standard); }
    
    .dd-header { font-size: 11px; color: var(--md-sys-color-outline); padding: 8px 16px; font-weight: 500; }
    .dd-item { 
      display: flex; align-items: center; gap: 12px; padding: 12px 16px; 
      cursor: pointer; color: var(--md-sys-color-on-background); font-size: 14px; 
    }
    .dd-item:hover { background: rgba(255,255,255,0.05); }
    .dd-divider { height: 1px; background: var(--md-sys-color-outline-variant); margin: 8px 0; }
    .dd-plan-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; cursor: pointer; color: var(--md-sys-color-on-background); font-size: 14px;
    }
    .dd-plan-row:hover { background: rgba(255,255,255,0.05); }

    /* --- Full Screen Dialog (Editor) --- */
    .backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 500; display: grid; place-items: center; opacity: 0; pointer-events: none; transition: 0.2s;
    }
    .backdrop.open { opacity: 1; pointer-events: auto; }
    
    .modal {
      width: 100%; max-width: 800px; height: 85vh; 
      background: var(--md-sys-color-surface);
      border-radius: var(--shape-corner-xl);
      display: flex; flex-direction: column;
      transform: scale(0.95); transition: 0.3s var(--ease-standard);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
    }
    .backdrop.open .modal { transform: scale(1); }

    /* Modal Header */
    .m-head { 
      padding: 24px 24px 16px; 
      background: var(--md-sys-color-surface);
    }
    .m-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .m-title { font-size: 24px; font-weight: 400; color: var(--md-sys-color-on-background); }

    /* Capacity Indicator (Linear Progress) */
    .capacity-wrapper { 
      width: 100%; height: 4px; background: var(--md-sys-color-surface-container-high);
      border-radius: 2px; overflow: hidden; display: flex; position: relative;
    }
    .gauge-filled {
      height: 100%; background: var(--md-sys-color-primary); 
      transition: width 0.3s var(--ease-standard);
    }
    .gauge-filled.over { background: var(--md-sys-color-error); }
    .gauge-text { 
      display: flex; justify-content: space-between; margin-top: 8px; 
      font-size: 12px; color: var(--md-sys-color-secondary); font-family: 'Roboto Mono'; 
    }

    /* Editor List */
    .m-body { 
      flex: 1; overflow-y: auto; padding: 0 24px 24px; 
      display: flex; flex-direction: column; gap: 8px;
    }

    /* Editor Row (Card) */
    .editor-card {
      display: grid; 
      /* Color | Input | Time | Duration | Delete */
      grid-template-columns: 40px 1.5fr 140px 60px 40px; 
      gap: 16px; align-items: center; padding: 8px 16px; 
      border-radius: 12px; background: var(--md-sys-color-surface-container-low);
      transition: 0.2s; border: 1px solid transparent;
    }
    .editor-card:hover { background: var(--md-sys-color-surface-container); }
    .editor-card.conflict { background: #2C1B1B; border-color: var(--md-sys-color-error); }
    
    .color-swatch {
      width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--md-sys-color-surface-container-high);
      position: relative; cursor: pointer; overflow: hidden;
    }
    .color-swatch input { position: absolute; opacity: 0; width: 200%; height: 200%; top:-50%; left:-50%; cursor: pointer; }

    /* Input Styling */
    .inp-title { 
      background: transparent; border: none; border-bottom: 1px solid var(--md-sys-color-outline-variant);
      color: var(--md-sys-color-on-background); font-size: 16px; font-weight: 400; padding: 8px 0; 
      font-family: 'Roboto'; outline: none; transition: 0.2s;
    }
    .inp-title:focus { border-bottom-color: var(--md-sys-color-primary); }

    .time-btn {
      height: 32px; border-radius: 8px; border: 1px solid var(--md-sys-color-outline);
      background: transparent; color: var(--md-sys-color-on-background);
      display: flex; align-items: center; justify-content: center; gap: 8px;
      font-size: 13px; font-family: 'Roboto Mono'; cursor: pointer;
    }
    .time-btn:hover { background: rgba(255,255,255,0.05); border-color: var(--md-sys-color-on-background); }

    .dur-badge { font-family: 'Roboto Mono'; font-size: 12px; color: var(--md-sys-color-secondary); text-align: right; }

    .del-icon {
      width: 40px; height: 40px; display: grid; place-items: center;
      color: var(--md-sys-color-outline); cursor: pointer; border-radius: 50%;
    }
    .del-icon:hover { background: rgba(255,180,171,0.1); color: var(--md-sys-color-error); }

    /* Modal Footer (Bottom Bar) */
    .m-foot { 
      padding: 16px 24px; border-top: 1px solid var(--md-sys-color-outline-variant);
      display: flex; justify-content: space-between; align-items: center;
      background: var(--md-sys-color-surface-container);
    }
    
    /* Filled Button (Primary) */
    .btn-filled {
      height: 40px; padding: 0 24px; border-radius: 20px;
      background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);
      border: none; font-weight: 500; font-size: 14px; cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .btn-filled:hover { box-shadow: 0 2px 4px 1px rgba(0,0,0,0.2); }
    .btn-filled:disabled { background: rgba(226, 226, 230, 0.12); color: rgba(226, 226, 230, 0.38); box-shadow: none; }

    .btn-text {
      height: 40px; padding: 0 12px; border-radius: 20px;
      background: transparent; color: var(--md-sys-color-primary);
      border: none; font-weight: 500; font-size: 14px; cursor: pointer;
    }
    .btn-text:hover { background: rgba(168, 199, 250, 0.08); }

    /* FAB in Modal */
    .fab-add {
      width: 56px; height: 56px; border-radius: 16px;
      background: var(--md-sys-color-tertiary); color: #291A00;
      display: grid; place-items: center; cursor: pointer;
      box-shadow: 0 4px 8px 3px rgba(0,0,0,0.15); margin-top: -28px;
    }
    .fab-add:hover { filter: brightness(1.05); }

    /* --- Clock Picker Dialog --- */
    .clk-bg { position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,0.6); display: none; place-items: center; }
    .clk-bg.show { display: grid; }
    .clk-card { 
      width: 320px; background: var(--md-sys-color-surface-container-high); 
      border-radius: 28px; padding: 24px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
    }
    
    .clk-head { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; }
    .clk-disp { display: flex; align-items: flex-end; gap: 4px; }
    .clk-in {
      background: var(--md-sys-color-surface-container-low); border: none; border-radius: 8px;
      width: 80px; height: 70px; text-align: center; font-family: 'Roboto'; font-size: 48px;
      color: var(--md-sys-color-on-background); outline: none;
    }
    .clk-in:focus { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }

    .clk-toggle {
      display: flex; background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 8px; overflow: hidden; margin-top: 12px;
    }
    .clk-t-opt { padding: 6px 16px; font-size: 12px; text-transform: uppercase; cursor: pointer; color: var(--md-sys-color-on-surface); }
    .clk-t-opt.active { background: var(--md-sys-color-secondary); color: #000; font-weight: 700; }

    .clk-face { 
      width: 256px; height: 256px; border-radius: 50%; background: var(--md-sys-color-surface-container-low); 
      margin: 0 auto; position: relative; 
    }
    .clk-num { 
      position: absolute; width: 32px; height: 32px; border-radius: 50%; 
      display: grid; place-items: center; font-size: 14px; color: var(--md-sys-color-on-background); 
      cursor: pointer; 
    }
    .clk-num:hover { background: rgba(255,255,255,0.1); }
    .clk-num.sel { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
    .clk-center-dot { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: var(--md-sys-color-primary); border-radius: 50%; transform: translate(-50%,-50%); }

    /* Save/Delete Mini Modals */
    .modal-mini { max-width: 320px; height: auto; padding: 24px; border-radius: 28px; }
    .mini-title { font-size: 22px; margin-bottom: 16px; color: var(--md-sys-color-on-background); }
    .mini-text { font-size: 14px; color: var(--md-sys-color-secondary); margin-bottom: 24px; }
    .mini-acts { display: flex; justify-content: flex-end; gap: 8px; }

    @keyframes fadeScale { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <svg class="logo" viewBox="0 0 40 40" fill="none">
        <rect width="40" height="40" rx="20" fill="#A8C7FA"/>
        <path d="M20 10V20L26 26" stroke="#062E6F" stroke-width="4" stroke-linecap="round"/>
      </svg>
      <h1>Chronos</h1>
    </div>
    
    <div class="top-actions">
      <div class="dropdown-wrapper">
        <button class="btn-tonal" onclick="App.menu('presets', event)">
          <span class="material-symbols-rounded">dashboard</span>
          Presets
        </button>
        <div class="dropdown-menu" id="menuPresets"></div>
      </div>
      <div class="dropdown-wrapper">
        <button class="btn-icon" onclick="App.menu('data', event)">
          <span class="material-symbols-rounded">more_vert</span>
        </button>
        <div class="dropdown-menu" id="menuData">
          <div class="dd-item" onclick="App.exp()">
            <span class="material-symbols-rounded">download</span> Export JSON
          </div>
          <div class="dd-item" style="position:relative">
            <span class="material-symbols-rounded">upload</span> Import JSON 
            <input type="file" onchange="App.imp(this)" style="position:absolute;inset:0;opacity:0;cursor:pointer">
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="stage">
    <div class="chart-wrapper">
      <svg id="chartSvg" viewBox="0 0 420 420">
        <defs id="defs"></defs>
        <circle cx="210" cy="210" r="160" class="track" />
        <g id="paths"></g>
        <g id="clockFace" class="ticks"></g>
        <path id="nowMarker" d="M 210 40 L 205 25 L 215 25 Z" /> 
      </svg>
      <div class="hub">
        <div class="hub-time" id="hubTime">00:00</div>
        <div class="hub-act" id="hubAct">Loading...</div>
        <div class="hub-rem" id="hubRem">-- min left</div>
      </div>
    </div>

    <div class="hud" id="hud">
      <div class="hud-l">Current Activity</div>
      <div class="hud-n" id="hudN">...</div>
      <div class="hud-t" id="hudT">...</div>
    </div>

    <div class="layout-dock">
      <div class="fab-group">
        <div class="fab-small active" id="tgLeg" onclick="App.toggleLeg()" title="Toggle Legend">
          <span class="material-symbols-rounded">list</span>
        </div>
        <div class="fab-large" onclick="App.edit()" title="Edit Schedule">
          <span class="material-symbols-rounded">edit</span>
        </div>
      </div>
      <div class="legend-panel" id="legPanel">
        <div class="l-head">My Day</div>
        <div class="l-list" id="legList"></div>
      </div>
    </div>
  </div>
</div>

<div class="backdrop" id="modal">
  <div class="modal">
    <div class="m-head">
      <div class="m-title-row">
        <div class="m-title">Edit Schedule</div>
        <button class="btn-icon" onclick="App.cancelEdit()"><span class="material-symbols-rounded">close</span></button>
      </div>
      
      <div class="capacity-wrapper">
        <div class="gauge-filled" id="capFill"></div>
      </div>
      <div class="gauge-text">
        <span id="capTxt">0h Scheduled</span>
        <span id="capRem">24h Free</span>
      </div>
    </div>

    <div class="m-body" id="rows"></div>
    
    <div class="m-foot">
      <div style="display:flex; gap:0px">
        <button class="btn-icon" onclick="App.undo()"><span class="material-symbols-rounded">undo</span></button>
        <button class="btn-icon" onclick="App.redo()"><span class="material-symbols-rounded">redo</span></button>
      </div>
      
      <div class="fab-add" onclick="App.add()">
        <span class="material-symbols-rounded">add</span>
      </div>

      <button class="btn-filled" id="saveBtn" onclick="App.saveEdit()">Save</button>
    </div>
  </div>
</div>

<div class="backdrop" id="saveModal">
  <div class="modal modal-mini"> 
    <div class="mini-title">Save Preset</div>
    <input type="text" id="planNameInput" class="inp-title" placeholder="Routine Name" style="width:100%; margin-bottom:24px">
    <div class="mini-acts">
      <button class="btn-text" onclick="App.closeSave()">Cancel</button>
      <button class="btn-filled" onclick="App.confirmSave()">Save</button>
    </div>
  </div>
</div>

<div class="backdrop" id="confirmModal">
  <div class="modal modal-mini">
    <div class="mini-title">Delete Plan?</div>
    <div class="mini-text">
      This will permanently delete this preset. This action cannot be undone.
    </div>
    <div class="mini-acts">
      <button class="btn-text" onclick="App.closeConfirm()">Cancel</button>
      <button class="btn-filled" onclick="App.finalizeDelete()" style="background:var(--md-sys-color-error); color: #690005">Delete</button>
    </div>
  </div>
</div>

<div class="clk-bg" id="clk">
  <div class="clk-card">
    <div class="clk-head">
      <div class="clk-toggle">
        <div class="clk-t-opt active" id="tabStart" onclick="App.selTab('start')">Start</div>
        <div class="clk-t-opt" id="tabEnd" onclick="App.selTab('end')">End</div>
      </div>
      <div class="clk-disp">
        <input type="text" class="clk-in" id="clkH" maxlength="2" oninput="App.onH(this)">
        <span style="font-size:32px; padding-bottom:10px">:</span>
        <input type="text" class="clk-in" id="clkM" maxlength="2" oninput="App.onM(this)">
      </div>
    </div>
    
    <div class="clk-face" id="cDial">
      <div class="clk-center-dot"></div>
    </div>
    
    <div class="mini-acts" style="margin-top:24px">
      <button class="btn-text" onclick="document.getElementById('clk').classList.remove('show')">Cancel</button>
      <button class="btn-filled" onclick="App.saveTS()">OK</button>
    </div>
  </div>
</div>

<script>
window.App = (() => {
  // Material Design 3 Colors (Pastels/Muted)
  const DEF = [
    { label: 'Sleep', start: '23:00', end: '07:00', color: '#8A90A3' }, // Neutral Variant
    { label: 'Morning Routine', start: '07:00', end: '08:30', color: '#F2B8B5' }, // Red
    { label: 'Deep Work', start: '08:30', end: '11:30', color: '#A8C7FA' }, // Blue
    { label: 'Break', start: '11:30', end: '13:00', color: '#C4EDD2' }, // Green
    { label: 'Focus Block', start: '13:00', end: '15:00', color: '#E8DEF8' }, // Purple
    { label: 'Admin', start: '15:00', end: '17:00', color: '#E6E1E5' }, // Surface Variant
    { label: 'Relax', start: '17:00', end: '21:00', color: '#FDD663' }, // Yellow
    { label: 'Wind Down', start: '21:00', end: '23:00', color: '#D7C0FF' } // Violet
  ];
  
  let items=[], hist=[], hIdx=-1, lOpen=true, sel=-1;
  let savedPlans = [];
  let tickInterval;
  let backupState = null; 
  let delIdx = -1;

  const $ = id => document.getElementById(id);
  const ui = {
    svg:$('paths'), defs:$('defs'), clock:$('clockFace'), marker:$('nowMarker'),
    hubTime:$('hubTime'), hubAct:$('hubAct'), hubRem:$('hubRem'), leg:$('legList'), pan:$('legPanel'),
    hud:$('hud'), hn:$('hudN'), ht:$('hudT'),
    mod:$('modal'), rows:$('rows'), cFill:$('capFill'), cTxt:$('capTxt'), cRem:$('capRem'),
    clk:$('clk'), dial:$('cDial'), menuP:$('menuPresets'),
    tabS:$('tabStart'), tabE:$('tabEnd'), clkH:$('clkH'), clkM:$('clkM'),
    saveMod: $('saveModal'), saveInp: $('planNameInput'), confMod: $('confirmModal')
  };

  let ts = { idx: -1, start: '', end: '', mode: 'start', unit: 'h' };

  const init = () => {
    try { items = JSON.parse(localStorage.getItem('chronos_current')) || JSON.parse(JSON.stringify(DEF)); } catch(e){ items=JSON.parse(JSON.stringify(DEF)); }
    try { savedPlans = JSON.parse(localStorage.getItem('chronos_saved_plans')) || []; } catch(e){ savedPlans=[]; }
    
    drawClockFace();
    rec(); render(); startClock();

    document.onclick = e => { 
      if(!e.target.closest('.dropdown-wrapper')) closeMenus();
      if(e.target.id === 'modal') cancelEdit(); 
      if(e.target.id === 'saveModal') closeSave();
      if(e.target.id === 'confirmModal') closeConfirm();
      if(!e.target.closest('path') && !e.target.closest('.l-item') && !e.target.closest('.layout-dock') && sel !== -1) select(-1); 
    };
  };

  const drawClockFace = () => {
    ui.clock.innerHTML = '';
    const r = 160, cx = 210, cy = 210;
    for (let i = 0; i < 24; i++) {
      const isMajor = i % 6 === 0;
      const ang = (i / 24) * 360 - 90;
      const rad = ang * Math.PI / 180;
      const len = isMajor ? 12 : 6;
      // Ticks inside the ring
      const x1 = cx + (r - 10) * Math.cos(rad);
      const y1 = cy + (r - 10) * Math.sin(rad);
      const x2 = cx + (r - 10 - len) * Math.cos(rad);
      const y2 = cy + (r - 10 - len) * Math.sin(rad);
      
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      if(isMajor) line.classList.add('major');
      ui.clock.append(line);

      if (isMajor) {
        const tx = cx + (r - 35) * Math.cos(rad);
        const ty = cy + (r - 35) * Math.sin(rad);
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', tx); txt.setAttribute('y', ty + 4); 
        txt.classList.add('tick-lbl');
        txt.textContent = String(i).padStart(2, '0');
        ui.clock.append(txt);
      }
    }
  };

  const startClock = () => { updateClock(); tickInterval = setInterval(updateClock, 1000); };

  const updateClock = () => {
    const now = new Date();
    const mins = now.getHours() * 60 + now.getMinutes();
    const deg = (mins / 1440) * 360;
    // Marker logic
    ui.marker.style.transform = `rotate(${deg}deg)`;

    ui.hubTime.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    
    let current = items.find(it => {
      const s = toM(it.start), e = toM(it.end);
      if (e < s) return mins >= s || mins < e; 
      return mins >= s && mins < e;
    });

    if (current) {
      ui.hubAct.textContent = current.label;
      // ui.hubAct.style.color = current.color; // Optional: Use theme color instead
      let endM = toM(current.end);
      if (endM < mins) endM += 1440;
      const diff = endM - mins;
      const rh = Math.floor(diff / 60), rm = diff % 60;
      ui.hubRem.textContent = rh > 0 ? `${rh}h ${rm}m left` : `${rm}m left`;
    } else {
      ui.hubAct.textContent = 'Free Time';
      ui.hubRem.textContent = '';
    }
  };

  const renderPresets = () => {
    let h = `<div class="dd-header">My Presets</div>`;
    if(savedPlans.length===0) h+=`<div style="padding:12px 16px;font-size:13px;color:#777;font-style:italic">No saved plans</div>`;
    else savedPlans.forEach((p,i)=>{ h+=`<div class="dd-plan-row" onclick="App.loadPlan(${i})"><span>${p.name}</span><div onclick="App.delPlan(${i},event)"><span class="material-symbols-rounded" style="font-size:18px; opacity:0.6">delete</span></div></div>`; });
    h+=`<div class="dd-divider"></div><div class="dd-header">System</div><div class="dd-item" onclick="App.load('def')"><span class="material-symbols-rounded">restart_alt</span> Restore Default</div><div class="dd-divider"></div><div class="dd-item" style="color:var(--md-sys-color-primary)" onclick="App.saveCurrent()"><span class="material-symbols-rounded">save</span> Save Current As...</div><div class="dd-item" style="color:var(--md-sys-color-error)" onclick="App.clear()"><span class="material-symbols-rounded">block</span> Clear Board</div>`;
    ui.menuP.innerHTML = h;
  };
  
  const saveCurrent = () => { 
    closeMenus();
    ui.saveInp.value = "";
    ui.saveMod.classList.add('open');
    setTimeout(() => ui.saveInp.focus(), 100);
  };
  const closeSave = () => ui.saveMod.classList.remove('open');
  const confirmSave = () => {
    const name = ui.saveInp.value.trim() || "Untitled Routine";
    savedPlans.push({ name, items: JSON.parse(JSON.stringify(items)) }); 
    localStorage.setItem('chronos_saved_plans', JSON.stringify(savedPlans)); 
    renderPresets(); closeSave();
  };
  const loadPlan = (i) => { items = JSON.parse(JSON.stringify(savedPlans[i].items)); rec(); render(); };
  const delPlan = (i, e) => { e.stopPropagation(); delIdx = i; ui.confMod.classList.add('open'); };
  const finalizeDelete = () => {
    if(delIdx > -1) { savedPlans.splice(delIdx, 1); localStorage.setItem('chronos_saved_plans', JSON.stringify(savedPlans)); renderPresets(); }
    closeConfirm();
  };
  const closeConfirm = () => { ui.confMod.classList.remove('open'); delIdx = -1; };

  const rec = () => { hist=hist.slice(0,hIdx+1); hist.push(JSON.stringify(items)); hIdx++; };
  const undo = () => { if(hIdx>0){ hIdx--; items=JSON.parse(hist[hIdx]); ref(); } };
  const redo = () => { if(hIdx<hist.length-1){ hIdx++; items=JSON.parse(hist[hIdx]); ref(); } };
  const ref = () => { render(); if(ui.mod.classList.contains('open')) editRows(); };

  const formatDur = (m) => { const h=Math.floor(m/60), n=Math.round(m%60); return h>0 && n>0 ? `${h}h ${n}m` : (h>0 ? `${h}h` : `${n}m`); };

  const render = () => {
    ui.svg.innerHTML=''; ui.leg.innerHTML='';
    const sorted = [...items].sort((a,b)=>toM(a.start)-toM(b.start));
    let t=0;

    sorted.forEach((it, i) => {
      const dur = getD(it.start, it.end); t+=dur;
      const origIdx = items.indexOf(it);

      const sM=toM(it.start), aS=(sM/1440)*360-90, aE=aS+(dur/1440)*360, r=160, cx=210, cy=210, rad=d=>d*Math.PI/180;
      const x1=cx+r*Math.cos(rad(aS)), y1=cy+r*Math.sin(rad(aS)), x2=cx+r*Math.cos(rad(aE)), y2=cy+r*Math.sin(rad(aE));
      const lg=dur>720?1:0; const d=`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${lg} 1 ${x2} ${y2} Z`;

      // Main Path
      const p=document.createElementNS('http://www.w3.org/2000/svg','path'); 
      p.setAttribute('d',d); p.setAttribute('class','segment'); 
      p.setAttribute('fill', it.color); 
      p.setAttribute('data-idx',origIdx);
      
      const l=document.createElement('div'); l.className='l-item'; l.setAttribute('data-idx',origIdx);
      l.innerHTML=`<div class="l-dot" style="background:${it.color}"></div><div class="l-info"><div class="l-name">${it.label}</div><div class="l-time">${it.start} - ${it.end}</div></div><div class="l-dur">${formatDur(dur)}</div>`;

      const act = (e) => { e.stopPropagation(); select(origIdx); };
      p.onclick=act; l.onclick=act;
      p.onmouseenter=()=>hover(origIdx,true); p.onmouseleave=()=>hover(origIdx,false);
      l.onmouseenter=()=>hover(origIdx,true); l.onmouseleave=()=>hover(origIdx,false);

      ui.svg.append(p); ui.leg.append(l);
    });
    localStorage.setItem('chronos_current', JSON.stringify(items));
    if(sel!==-1) highlight(sel);
    updateClock(); 
  };

  const select = (i) => { sel=i; highlight(i); };
  const highlight = (i) => {
    Array.from(ui.svg.children).forEach(p=>{p.classList.remove('active')}); Array.from(ui.leg.children).forEach(l=>l.classList.remove('active'));
    if(i!==-1){
      const p=ui.svg.querySelector(`path[data-idx="${i}"]`), l=ui.leg.querySelector(`div[data-idx="${i}"]`);
      if(p){ ui.svg.appendChild(p); p.classList.add('active'); }
      if(l){ l.classList.add('active'); if(lOpen)l.scrollIntoView({behavior:'smooth',block:'nearest'}); }
      showHud(items[i]);
    } else ui.hud.classList.remove('visible');
  };
  const hover = (i, act) => { if(sel!==-1)return; if(act){ highlight(i); if(!lOpen) showHud(items[i]); } else highlight(-1); };
  const showHud = (it) => { ui.hn.innerText=it.label; ui.ht.innerText=`${it.start} - ${it.end}`; ui.hud.classList.add('visible'); };

  const editRows = () => {
    ui.rows.innerHTML=''; let t=0;
    const map=new Array(1440).fill(0);
    items.forEach(x=>{ const s=toM(x.start), d=getD(x.start,x.end); for(let k=0;k<d;k++) map[(s+k)%1440]++; });
    
    items.forEach((it, i) => {
      const d=getD(it.start,it.end); t+=d; const s=toM(it.start); let c=false; for(let k=0;k<d;k++)if(map[(s+k)%1440]>1)c=true;
      const el=document.createElement('div'); el.className=`editor-card ${c?'conflict':''}`;
      el.innerHTML=`
        <div class="color-swatch" style="background:${it.color}"><input type="color" value="${it.color}" onchange="App.upd(${i},'color',this.value)"></div>
        <input class="inp-title" value="${it.label}" placeholder="Activity Name" onchange="App.upd(${i},'label',this.value)">
        
        <button class="time-btn" onclick="App.openTS(${i})">
          ${it.start} - ${it.end}
        </button>

        <div class="dur-badge">${formatDur(d)}</div>
        <div class="del-icon" onclick="App.del(${i})"><span class="material-symbols-rounded">delete</span></div>
      `;
      ui.rows.append(el);
    });
    
    const pct = (t/(24*60))*100;
    ui.cFill.style.width = `${Math.min(100, pct)}%`;
    ui.cTxt.innerText = `${formatDur(t)} Scheduled`;
    ui.cRem.innerText = `${formatDur(Math.max(0, 1440 - t))} Free`;
    ui.cFill.className = `gauge-filled ${t > 24*60 ? 'over' : ''}`;
    
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = t > 24*60;
  };

  const upd = (i,k,v) => { items[i][k]=v; rec(); editRows(); };

  const openTS = (i) => {
    ts = { idx: i, start: items[i].start, end: items[i].end, mode: 'start', unit: 'h' };
    selTab('start');
    ui.clk.classList.add('show');
  };

  const selTab = (m) => {
    ts.mode = m;
    ui.tabS.className = `clk-t-opt ${m==='start'?'active':''}`;
    ui.tabE.className = `clk-t-opt ${m==='end'?'active':''}`;
    const val = m === 'start' ? ts.start : ts.end;
    const [h, mn] = val.split(':');
    ui.clkH.value = h;
    ui.clkM.value = mn;
    ui.clkH.focus();
    ts.unit = 'h'; renderDial();
  };

  const onH = (el) => {
    let v = el.value.replace(/\D/g,'');
    if(parseInt(v) > 23) v = '23';
    el.value = v;
    if(v.length === 2) ui.clkM.focus();
    syncState();
  };
  const onM = (el) => {
    let v = el.value.replace(/\D/g,'');
    if(parseInt(v) > 59) v = '59';
    el.value = v;
    syncState();
  };

  const syncState = () => {
    const h = ui.clkH.value.padStart(2,'0');
    const m = ui.clkM.value.padStart(2,'0');
    if (ts.mode === 'start') ts.start = `${h}:${m}`; else ts.end = `${h}:${m}`;
    if(h.length > 0 && m.length > 0) renderDial();
  };

  const renderDial = () => {
    ui.dial.innerHTML = '<div class="clk-center-dot"></div>';
    const val = ts.mode === 'start' ? ts.start : ts.end;
    const [hStr, mStr] = val.split(':');
    const h = parseInt(hStr)||0, m = parseInt(mStr)||0;
    const isH = ts.unit === 'h';
    const cnt = isH ? 24 : 12;
    
    for(let j=0; j<cnt; j++){
      let n = j, r = 110;
      if(isH) { if(j>11) r = 75; } else n = j * 5;

      const a = (n % 12) * 30 - 90;
      const rad = a * Math.PI / 180;
      const x = 128 + r * Math.cos(rad);
      const y = 128 + r * Math.sin(rad);

      const d = document.createElement('div');
      const isSel = isH ? (n === h) : (Math.abs(n - m) < 3);
      d.className = `clk-num ${isSel ? 'sel' : ''}`;
      d.innerText = n;
      d.style.left = (x - 16) + 'px';
      d.style.top = (y - 16) + 'px';
      
      d.onclick = () => {
        if (isH) {
          ui.clkH.value = String(n).padStart(2,'0');
          syncState(); ts.unit = 'm'; ui.clkM.focus(); renderDial();
        } else {
          ui.clkM.value = String(n).padStart(2,'0');
          syncState();
          if (ts.mode === 'start') selTab('end');
          else { ts.unit = 'h'; renderDial(); }
        }
      };
      ui.dial.append(d);
    }
  };

  const saveTS = () => {
    items[ts.idx].start = ts.start; items[ts.idx].end = ts.end;
    rec(); editRows(); ui.clk.classList.remove('show');
  };

  const closeMenus = () => document.querySelectorAll('.dropdown-menu').forEach(d=>d.classList.remove('show'));
  const menu = (id, e) => { e.stopPropagation(); const m=$('menu'+(id==='presets'?'Presets':'Data')); const w=m.classList.contains('show'); closeMenus(); if(!w){ if(id==='presets')renderPresets(); m.classList.add('show'); }};
  const toggleLeg = () => { lOpen=!lOpen; $('tgLeg').classList.toggle('active'); ui.pan.classList.toggle('hidden'); if(!lOpen && sel!==-1) showHud(items[sel]); else ui.hud.classList.remove('visible'); };
  const toM=t=>{const[h,m]=t.split(':').map(Number);return h*60+m;};
  const getD=(s,e)=>{let d=toM(e)-toM(s);return d<0?d+1440:d;};
  
  const edit = () => { backupState = JSON.stringify(items); rec(); editRows(); ui.mod.classList.add('open'); };
  const cancelEdit = () => { if(backupState) items=JSON.parse(backupState); ui.mod.classList.remove('open'); render(); };
  const saveEdit = () => { ui.mod.classList.remove('open'); render(); };

  return { init, undo, redo, menu, toggleLeg, edit, cancelEdit, saveEdit,
    add:()=>{
      const l=items[items.length-1]||{end:'00:00'}; 
      const nextM = (toM(l.end) + 60) % 1440;
      const h = Math.floor(nextM/60);
      const m = nextM % 60;
      const nextT = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      items.push({label:'New Activity',start:l.end,end:nextT, color:'#C4C7D0'}); 
      rec(); editRows(); ui.rows.scrollTop=ui.rows.scrollHeight
    },
    del:(i)=>{items.splice(i,1);rec();editRows()}, upd, openTS, selTab, onH, onM, saveTS, 
    closeSave, confirmSave, closeConfirm, finalizeDelete,
    clear:()=>{items=[];rec();render();closeMenus()},
    load:(t)=>{items=t==='def'?JSON.parse(JSON.stringify(DEF)):(JSON.parse(localStorage.getItem('chronos_current'))||[]);rec();render()},
    saveCurrent, loadPlan, delPlan,
    exp:()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(items)],{type:'application/json'}));a.download='plan.json';a.click()},
    imp:(el)=>{const r=new FileReader();r.onload=e=>{try{items=JSON.parse(e.target.result);rec();render();}catch(x){}};if(el.files[0])r.readAsText(el.files[0])}
  };
})();
window.onload = window.App.init;
</script>
</body>
</html>
